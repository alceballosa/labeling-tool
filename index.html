<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="favicon.ico">

    <title>Polygon validation tool</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
        body {
            padding-top: 2rem;
            padding-left: 6rem;
            padding-right: 6em;
        }

        .row {
            margin-bottom: 2rem;
        }

        .center {
            text-align: center;
        }



        #btnCorrect {
            color: #fff;
            background-color: rgb(0, 128, 0);
            border-color: rgb(0, 128, 0);
        }

        #btnCorrect:hover {
            color: #000;
        }

        #btnIncorrect {
            color: #fff;
            background-color: rgb(128, 0, 0);
            border-color: rgb(128, 0, 0);
        }

        #btnIncorrect:hover {
            color: #000;
        }

        #btnUnsure {
            color: #000;
            background-color: rgb(255, 255, 255);
            border-color: rgb(100, 100, 100);
        }

        #btnUnsure:hover {
            color: #ccc;
        }


        .satelliteImage {
            max-width: 340px;
            border: 1px solid black;
        }



        .cellExplanation {
            text-align: left;
            vertical-align: center;
            width: 240px;
        }

        table td{
            padding:5px;
        }

        .imgContainer {
            padding: 30px;
        }


        .dimmed {
            position: relative;
        }

        .dimmed:after {
            content: " ";
            z-index: 10;
            display: block;
            position: absolute;
            height: 100%;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.5);
        }


        .pixelated {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            -ms-interpolation-mode: nearest-neighbor;
        }

    </style>

</head>

<body>

    <div class="container-fluid">

        <div class="row">
            <div class="col-md-12">
                <h1>Poultry barn validation tool</h1>
            </div>
        </div>

        <div class="row">

            <div class="col-sm-12">

                <div class="row center imgContainer">
                    <div class="col-sm-4">
                        <img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" class="satelliteImage" id="img0-0" />
                        <img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" class="satelliteImage" id="img0-1" />
                    </div>
                    <div class="col-sm-4">
                        <img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" class="satelliteImage" id="img1-0" />
                        <img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" class="satelliteImage" id="img1-1" />
                    </div>
                    <div class="col-sm-4">
                        <img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" class="satelliteImage" id="img2-0" />
                        <img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" class="satelliteImage" id="img2-1" />
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="col-xl-4 mb-3">
                        <button type="button" class="btn btn-lg btn-block" id="btnCorrect" data-label="correct">Correct (1)</button>
                    </div>
                    <div class="col-xl-4 mb-3">
                        <button type="button" class="btn btn-lg btn-block" id="btnIncorrect" data-label="incorrect">Incorrect (2)</button>
                    </div>
                    <div class="col-xl-4 mb-3">
                        <button type="button" class="btn btn-lg btn-block" id="btnUnsure" data-label="unsure">Unsure (3)</button>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="col-sm-12">
                        Number of labels submitted: <span id="lblNumLabeled">0</span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <h2 class="mb-4">Instructions</h2>
                        <p>The above pairs of images show a single area at three levels of increasing spatial context. The red highlighted area shows what the model has predicted as a poultry barn.</p>
                        <p>
                            Use the buttons to mark a prediction as "correct", "incorrect", or "unsure".<br/>
                            If the red highlighted area is covering some portion of a building, then assume that the entire building has been identified as a poultry barn. In other words, do <b>not</b> mark a prediction that partially covers a poultry barn as "incorrect" just because the entire building is not highlighted in red.<br/>
                            If you are unsure of the correct labeling do not guess, select "unsure".
                        </p>
                        <p>You can also use the hotkeys 1-3 (the corresonding number is labeled on each button) instead of clicking.</p>
                    </div>

                    <div class="col-md-12">
                        <h3 class="mb-4 mt-4">Classification guide</h3>
                        <p>
                            Poultry barns are generally long and narrow with several attached feeders, along with vents/fans on the ends of the barns (may or may not be visible).
                            They do not use the same waste disposal system as the cattle/swine barns, so there is usually no lagoon nearby.
                        </p>
                        <p>
                            The overall shape of the barn is usually the most valuable indicator.
                        </p>
                        <p class="mb-4">
                            Close-up of an attached feeder:
                            <img src="img/examples/feeder_example.png" style="width:120px;"/>
                        </p>


                        <h4 class="mb-4 mt-4">Correct classifications</h4>
                        <table>
                            <tr>
                                <td class="cellExplanation">The barn is the correct shape and feeders/vents are visible.</td>
                                <td><img src="img/examples/correct2-1.jfif" class="satelliteImage mr-2"/><img src="img/examples/correct2-2.jfif" class="satelliteImage"/></td>
                            </tr>
                            <tr>
                                <td class="cellExplanation">The barn is the correct shape and feeders/vents are visible.</td>
                                <td><img src="img/examples/correct3-1.jfif" class="satelliteImage mr-2"/><img src="img/examples/correct3-2.jfif" class="satelliteImage"/></td>
                            </tr>
                            <tr>
                                <td class="cellExplanation">The barn is the correct shape and feeders are visible.</td>
                                <td><img src="img/examples/correct4-1.jfif" class="satelliteImage mr-2"/><img src="img/examples/correct4-2.jfif" class="satelliteImage"/></td>
                            </tr>
                            <tr>
                                <td class="cellExplanation">The barn is the correct shape and feeders are visible.</td>
                                <td><img src="img/examples/correct5-1.jfif" class="satelliteImage mr-2"/><img src="img/examples/correct5-2.jfif" class="satelliteImage"/></td>
                            </tr>
                            <tr>
                                <td class="cellExplanation">The barn is the correct shape and feeders are visible.</td>
                                <td><img src="img/examples/correct6-1.jfif" class="satelliteImage mr-2"/><img src="img/examples/correct6-2.jfif" class="satelliteImage"/></td>
                            </tr>
                        </table>


                        <h4 class="mb-4 mt-4">Incorrect classifications</h4>
                        <table>
                            <tr>
                                <td class="cellExplanation">The barn is the correct shape, however no feeders are visible, and it is positioned parallel to a paved road (see the powerlines) which is not usual of a poultry barn.</td>
                                <td><img src="img/examples/incorrect1-1.jfif" class="satelliteImage mr-2"/><img src="img/examples/incorrect1-2.jfif" class="satelliteImage"/></td>
                            </tr>
                            <tr>
                                <td class="cellExplanation">The barn is not the correct shape to be a poultry barn. There are feeders and a nearby lagoon, so this is likely a swine barn.</td>
                                <td><img src="img/examples/incorrect2-1.jfif" class="satelliteImage mr-2"/><img src="img/examples/incorrect2-2.jfif" class="satelliteImage"/></td>
                            </tr>
                            <tr>
                                <td class="cellExplanation">The barn (or, more likely, the warehouse) is not the correct shape, and it looks to be in a heavily industrial area.</td>
                                <td><img src="img/examples/incorrect3-1.jfif" class="satelliteImage mr-2"/><img src="img/examples/incorrect3-2.jfif" class="satelliteImage"/></td>
                            </tr>
                            <tr>
                                <td class="cellExplanation">This is a road -- definitely not a poultry barn.</td>
                                <td><img src="img/examples/incorrect4-1.jfif" class="satelliteImage mr-2"/><img src="img/examples/incorrect4-2.jfif" class="satelliteImage"/></td>
                            </tr>
                            <tr>
                                <td class="cellExplanation">This is a commercial building of some sort -- definitely not a poultry barn.</td>
                                <td><img src="img/examples/incorrect5-1.jfif" class="satelliteImage mr-2"/><img src="img/examples/incorrect5-2.jfif" class="satelliteImage"/></td>
                            </tr>
                            <tr>
                                <td class="cellExplanation">The barn is not the correct shape, however feeders may be visible. This is likely a swine barn.</td>
                                <td><img src="img/examples/unsure2-1.jfif" class="satelliteImage mr-2"/><img src="img/examples/unsure2-2.jfif" class="satelliteImage"/></td>
                            </tr>
                        </table>


                        <h4 class="mb-4 mt-4">Unsure classifications</h4>
                        <table>
                            <tr>
                                <td class="cellExplanation">The barn is the correct shape, however there are no feeders visible and there are residential buildings visible.</td>
                                <td><img src="img/examples/unsure1-1.jfif" class="satelliteImage mr-2"/><img src="img/examples/unsure1-2.jfif" class="satelliteImage"/></td>
                            </tr>
                            <tr>
                                <td class="cellExplanation">The barn is the correct shape, however there are no feeders visible and the roof shape/texture is different from normal poultry barns. This may be a greenhouse.</td>
                                <td><img src="img/examples/unsure3-1.jfif" class="satelliteImage mr-2"/><img src="img/examples/unsure3-2.jfif" class="satelliteImage"/></td>
                            </tr>
                            <tr>
                                <td class="cellExplanation">The barn is not the correct shape and there are no feeders visible. This may be a greenhouse.</td>
                                <td><img src="img/examples/unsure4-1.jfif" class="satelliteImage mr-2"/><img src="img/examples/unsure4-2.jfif" class="satelliteImage"/></td>
                            </tr>
                        </table>



                    </div>
                </div>

            </div>

        </div>
    </div>

    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>

    <script type="text/javascript">

        var BACKEND_URL = "http://caleb-gpu.eastus.cloudapp.azure.com:4042/"
        var isLoading = false;

        var clientIdx = "none";
        var currentSample = null;
        var numLabeled = 0;

        var notifyFail = function (jqXHR, textStatus, errorThrown) {
            var response = $.parseJSON(jqXHR.responseText);
            console.log("Error in processing server: " + response.error);
        };


        var recordSample = function (label) {
            currentSample["user_label"] = label;
            currentSample["client_idx"] = clientIdx;

            $.ajax({
                type: "POST",
                url: BACKEND_URL + "recordSample",
                data: JSON.stringify(currentSample),
                success: function (data, textStatus, jqXHR) {

                    numLabeled += 1;
                    $("#lblNumLabeled").text(numLabeled);
                    getSample();
                },
                error: notifyFail,
                dataType: "json",
                contentType: "application/json"
            });

        };

        var getSample = function () {
            $(".imgContainer").addClass("dimmed");
            isLoading = true;

            $.ajax({
                type: "POST",
                url: BACKEND_URL + "getSample",
                data: JSON.stringify({ "sample": true }),
                success: function (data, textStatus, jqXHR) {

                    var numImages = data["img_pairs"].length;
                    for(var i=0;i<3;i++){
                        var img1 = "data:image/jpeg;base64," + data["img_pairs"][i][0];
                        var img2 = "data:image/jpeg;base64," + data["img_pairs"][i][1];
                        
                        $("#img"+i+"-0").attr("src", img1);
                        $("#img"+i+"-1").attr("src", img2);
                    }

                    delete data["img_pairs"];

                    currentSample = data;
                    $(".imgContainer").removeClass("dimmed");
                    isLoading = false;
                },
                error: notifyFail,
                dataType: "json",
                contentType: "application/json"
            });
        };


        $(document).ready(function () {
            
            var url = new URL(window.location.href);
    
            var tClientIdx = url.searchParams.get("clientIdx");
            if(tClientIdx === null) {
                clientIdx = "none";
            }else{
                clientIdx = tClientIdx;
            }

            getSample();

            $(".btn").click(function () {
                if (!isLoading) {
                    recordSample($(this).data("label"));
                }
            })

            $(document).keypress(function (e) {
                console.debug(e.which)
                if (!isLoading) {
                    if (e.which == 49) {
                        recordSample("correct");
                    }
                    else if (e.which == 50) {
                        recordSample("incorrect");
                    }
                    else if (e.which == 51) {
                        recordSample("unsure");
                    }
                }
                e.preventDefault();
            });

        });

    </script>
</body>

</html>